!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var Peer=require("peerjs"),peer=new Peer({key:"ob1bohiqjkedn29"}),video=document.querySelector("video");peer.on("connection",function(conn){console.log("On connection",conn)}),peer.on("open",function(id){console.log("My ID ",id);var peerId=window.location.search.replace("?","")||"electron-video";console.log("peerID",peerId);peer.connect(peerId)}),peer.on("call",function(call){console.log("on call",call),call.answer(),call.on("stream",function(stream){video.src=URL.createObjectURL(stream)})})},{peerjs:6}],2:[function(require,module,exports){module.exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,module.exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,module.exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate},{}],3:[function(require,module,exports){function DataConnection(peer,provider,options){return this instanceof DataConnection?(EventEmitter.call(this),this.options=util.extend({serialization:"binary",reliable:!1},options),this.open=!1,this.type="data",this.peer=peer,this.provider=provider,this.id=this.options.connectionId||DataConnection._idPrefix+util.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void Negotiator.startConnection(this,this.options._payload||{originator:!0})):new DataConnection(peer,provider,options)}var util=require("./util"),EventEmitter=require("eventemitter3"),Negotiator=require("./negotiator"),Reliable=require("reliable");util.inherits(DataConnection,EventEmitter),DataConnection._idPrefix="dc_",DataConnection.prototype.initialize=function(dc){this._dc=this.dataChannel=dc,this._configureDataChannel()},DataConnection.prototype._configureDataChannel=function(){var self=this;util.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){util.log("Data channel connection success"),self.open=!0,self.emit("open")},!util.supports.sctp&&this.reliable&&(this._reliable=new Reliable(this._dc,util.debug)),this._reliable?this._reliable.onmessage=function(msg){self.emit("data",msg)}:this._dc.onmessage=function(e){self._handleDataMessage(e)},this._dc.onclose=function(e){util.log("DataChannel closed for:",self.peer),self.close()}},DataConnection.prototype._handleDataMessage=function(e){var self=this,data=e.data,datatype=data.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(datatype===Blob)return void util.blobToArrayBuffer(data,function(ab){data=util.unpack(ab),self.emit("data",data)});if(datatype===ArrayBuffer)data=util.unpack(data);else if(datatype===String){var ab=util.binaryStringToArrayBuffer(data);data=util.unpack(ab)}}else"json"===this.serialization&&(data=JSON.parse(data));if(data.__peerData){var id=data.__peerData,chunkInfo=this._chunkedData[id]||{data:[],count:0,total:data.total};return chunkInfo.data[data.n]=data.data,chunkInfo.count+=1,chunkInfo.total===chunkInfo.count&&(delete this._chunkedData[id],data=new Blob(chunkInfo.data),this._handleDataMessage({data:data})),void(this._chunkedData[id]=chunkInfo)}this.emit("data",data)},DataConnection.prototype.close=function(){this.open&&(this.open=!1,Negotiator.cleanup(this),this.emit("close"))},DataConnection.prototype.send=function(data,chunked){if(!this.open)return void this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));if(this._reliable)return void this._reliable.send(data);var self=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(data));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var blob=util.pack(data),needsChunking=util.chunkedBrowsers[this._peerBrowser]||util.chunkedBrowsers[util.browser];if(needsChunking&&!chunked&&blob.size>util.chunkedMTU)return void this._sendChunks(blob);util.supports.sctp?util.supports.binaryBlob?this._bufferedSend(blob):util.blobToArrayBuffer(blob,function(ab){self._bufferedSend(ab)}):util.blobToBinaryString(blob,function(str){self._bufferedSend(str)})}else this._bufferedSend(data)},DataConnection.prototype._bufferedSend=function(msg){(this._buffering||!this._trySend(msg))&&(this._buffer.push(msg),this.bufferSize=this._buffer.length)},DataConnection.prototype._trySend=function(msg){try{this._dc.send(msg)}catch(e){this._buffering=!0;var self=this;return setTimeout(function(){self._buffering=!1,self._tryBuffer()},100),!1}return!0},DataConnection.prototype._tryBuffer=function(){if(0!==this._buffer.length){var msg=this._buffer[0];this._trySend(msg)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},DataConnection.prototype._sendChunks=function(blob){for(var blobs=util.chunk(blob),i=0,ii=blobs.length;ii>i;i+=1){var blob=blobs[i];this.send(blob,!0)}},DataConnection.prototype.handleMessage=function(message){var payload=message.payload;switch(message.type){case"ANSWER":this._peerBrowser=payload.browser,Negotiator.handleSDP(message.type,this,payload.sdp);break;case"CANDIDATE":Negotiator.handleCandidate(this,payload.candidate);break;default:util.warn("Unrecognized message type:",message.type,"from peer:",this.peer)}},module.exports=DataConnection},{"./negotiator":5,"./util":8,eventemitter3:9,reliable:12}],4:[function(require,module,exports){function MediaConnection(peer,provider,options){return this instanceof MediaConnection?(EventEmitter.call(this),this.options=util.extend({},options),this.open=!1,this.type="media",this.peer=peer,this.provider=provider,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||MediaConnection._idPrefix+util.randomToken(),void(this.localStream&&Negotiator.startConnection(this,{_stream:this.localStream,originator:!0}))):new MediaConnection(peer,provider,options)}var util=require("./util"),EventEmitter=require("eventemitter3"),Negotiator=require("./negotiator");util.inherits(MediaConnection,EventEmitter),MediaConnection._idPrefix="mc_",MediaConnection.prototype.addStream=function(remoteStream){util.log("Receiving stream",remoteStream),this.remoteStream=remoteStream,this.emit("stream",remoteStream)},MediaConnection.prototype.handleMessage=function(message){var payload=message.payload;switch(message.type){case"ANSWER":Negotiator.handleSDP(message.type,this,payload.sdp),this.open=!0;break;case"CANDIDATE":Negotiator.handleCandidate(this,payload.candidate);break;default:util.warn("Unrecognized message type:",message.type,"from peer:",this.peer)}},MediaConnection.prototype.answer=function(stream){if(this.localStream)return void util.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");this.options._payload._stream=stream,this.localStream=stream,Negotiator.startConnection(this,this.options._payload);for(var messages=this.provider._getMessages(this.id),i=0,ii=messages.length;ii>i;i+=1)this.handleMessage(messages[i]);this.open=!0},MediaConnection.prototype.close=function(){this.open&&(this.open=!1,Negotiator.cleanup(this),this.emit("close"))},module.exports=MediaConnection},{"./negotiator":5,"./util":8,eventemitter3:9}],5:[function(require,module,exports){var util=require("./util"),RTCPeerConnection=require("./adapter").RTCPeerConnection,RTCSessionDescription=require("./adapter").RTCSessionDescription,RTCIceCandidate=require("./adapter").RTCIceCandidate,Negotiator={pcs:{data:{},media:{}},queue:[]};Negotiator._idPrefix="pc_",Negotiator.startConnection=function(connection,options){var pc=Negotiator._getPeerConnection(connection,options);if("media"===connection.type&&options._stream&&pc.addStream(options._stream),connection.pc=connection.peerConnection=pc,options.originator){if("data"===connection.type){var config={};util.supports.sctp||(config={reliable:options.reliable});var dc=pc.createDataChannel(connection.label,config);connection.initialize(dc)}util.supports.onnegotiationneeded||Negotiator._makeOffer(connection)}else Negotiator.handleSDP("OFFER",connection,options.sdp)},Negotiator._getPeerConnection=function(connection,options){Negotiator.pcs[connection.type]||util.error(connection.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),Negotiator.pcs[connection.type][connection.peer]||(Negotiator.pcs[connection.type][connection.peer]={});var pc;Negotiator.pcs[connection.type][connection.peer];return options.pc&&(pc=Negotiator.pcs[connection.type][connection.peer][options.pc]),pc&&"stable"===pc.signalingState||(pc=Negotiator._startPeerConnection(connection)),pc},Negotiator._startPeerConnection=function(connection){util.log("Creating RTCPeerConnection.");var id=Negotiator._idPrefix+util.randomToken(),optional={};"data"!==connection.type||util.supports.sctp?"media"===connection.type&&(optional={optional:[{DtlsSrtpKeyAgreement:!0}]}):optional={optional:[{RtpDataChannels:!0}]};var pc=new RTCPeerConnection(connection.provider.options.config,optional);return Negotiator.pcs[connection.type][connection.peer][id]=pc,Negotiator._setupListeners(connection,pc,id),pc},Negotiator._setupListeners=function(connection,pc,pc_id){var peerId=connection.peer,connectionId=connection.id,provider=connection.provider;util.log("Listening for ICE candidates."),pc.onicecandidate=function(evt){evt.candidate&&(util.log("Received ICE candidates for:",connection.peer),provider.socket.send({type:"CANDIDATE",payload:{candidate:evt.candidate,type:connection.type,connectionId:connection.id},dst:peerId}))},pc.oniceconnectionstatechange=function(){switch(pc.iceConnectionState){case"disconnected":case"failed":util.log("iceConnectionState is disconnected, closing connections to "+peerId),connection.close();break;case"completed":pc.onicecandidate=util.noop}},pc.onicechange=pc.oniceconnectionstatechange,util.log("Listening for `negotiationneeded`"),pc.onnegotiationneeded=function(){util.log("`negotiationneeded` triggered"),"stable"==pc.signalingState?Negotiator._makeOffer(connection):util.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},util.log("Listening for data channel"),pc.ondatachannel=function(evt){util.log("Received data channel");var dc=evt.channel,connection=provider.getConnection(peerId,connectionId);connection.initialize(dc)},util.log("Listening for remote stream"),pc.onaddstream=function(evt){util.log("Received remote stream");var stream=evt.stream,connection=provider.getConnection(peerId,connectionId);"media"===connection.type&&connection.addStream(stream)}},Negotiator.cleanup=function(connection){util.log("Cleaning up PeerConnection to "+connection.peer);var pc=connection.pc;!pc||"closed"===pc.readyState&&"closed"===pc.signalingState||(pc.close(),connection.pc=null)},Negotiator._makeOffer=function(connection){var pc=connection.pc;pc.createOffer(function(offer){util.log("Created offer."),!util.supports.sctp&&"data"===connection.type&&connection.reliable&&(offer.sdp=Reliable.higherBandwidthSDP(offer.sdp)),pc.setLocalDescription(offer,function(){util.log("Set localDescription: offer","for:",connection.peer),connection.provider.socket.send({type:"OFFER",payload:{sdp:offer,type:connection.type,label:connection.label,connectionId:connection.id,reliable:connection.reliable,serialization:connection.serialization,metadata:connection.metadata,browser:util.browser},dst:connection.peer})},function(err){connection.provider.emitError("webrtc",err),util.log("Failed to setLocalDescription, ",err)})},function(err){connection.provider.emitError("webrtc",err),util.log("Failed to createOffer, ",err)},connection.options.constraints)},Negotiator._makeAnswer=function(connection){var pc=connection.pc;pc.createAnswer(function(answer){util.log("Created answer."),!util.supports.sctp&&"data"===connection.type&&connection.reliable&&(answer.sdp=Reliable.higherBandwidthSDP(answer.sdp)),pc.setLocalDescription(answer,function(){util.log("Set localDescription: answer","for:",connection.peer),connection.provider.socket.send({type:"ANSWER",payload:{sdp:answer,type:connection.type,connectionId:connection.id,browser:util.browser},dst:connection.peer})},function(err){connection.provider.emitError("webrtc",err),util.log("Failed to setLocalDescription, ",err)})},function(err){connection.provider.emitError("webrtc",err),util.log("Failed to create answer, ",err)})},Negotiator.handleSDP=function(type,connection,sdp){sdp=new RTCSessionDescription(sdp);var pc=connection.pc;util.log("Setting remote description",sdp),pc.setRemoteDescription(sdp,function(){util.log("Set remoteDescription:",type,"for:",connection.peer),"OFFER"===type&&Negotiator._makeAnswer(connection)},function(err){connection.provider.emitError("webrtc",err),util.log("Failed to setRemoteDescription, ",err)})},Negotiator.handleCandidate=function(connection,ice){var candidate=ice.candidate,sdpMLineIndex=ice.sdpMLineIndex;connection.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:sdpMLineIndex,candidate:candidate})),util.log("Added ICE candidate for:",connection.peer)},module.exports=Negotiator},{"./adapter":2,"./util":8}],6:[function(require,module,exports){function Peer(id,options){return this instanceof Peer?(EventEmitter.call(this),id&&id.constructor==Object?(options=id,id=void 0):id&&(id=id.toString()),options=util.extend({debug:0,host:util.CLOUD_HOST,port:util.CLOUD_PORT,key:"peerjs",path:"/",token:util.randomToken(),config:util.defaultConfig},options),this.options=options,"/"===options.host&&(options.host=window.location.hostname),"/"!==options.path[0]&&(options.path="/"+options.path),"/"!==options.path[options.path.length-1]&&(options.path+="/"),void 0===options.secure&&options.host!==util.CLOUD_HOST&&(options.secure=util.isSecure()),options.logFunction&&util.setLogFunction(options.logFunction),util.setLogLevel(options.debug),util.supports.audioVideo||util.supports.data?util.validateId(id)?util.validateKey(options.key)?options.secure&&"0.peerjs.com"===options.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(id?this._initialize(id):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+options.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+id+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new Peer(id,options)}var util=require("./util"),EventEmitter=require("eventemitter3"),Socket=require("./socket"),MediaConnection=require("./mediaconnection"),DataConnection=require("./dataconnection");util.inherits(Peer,EventEmitter),Peer.prototype._initializeServerConnection=function(){var self=this;this.socket=new Socket(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(data){self._handleMessage(data)}),this.socket.on("error",function(error){self._abort("socket-error",error)}),this.socket.on("disconnected",function(){self.disconnected||(self.emitError("network","Lost connection to server."),self.disconnect())}),this.socket.on("close",function(){self.disconnected||self._abort("socket-closed","Underlying socket is already closed.")})},Peer.prototype._retrieveId=function(cb){var self=this,http=new XMLHttpRequest,protocol=this.options.secure?"https://":"http://",url=protocol+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id",queryString="?ts="+(new Date).getTime()+Math.random();url+=queryString,http.open("get",url,!0),http.onerror=function(e){util.error("Error retrieving ID",e);var pathError="";"/"===self.options.path&&self.options.host!==util.CLOUD_HOST&&(pathError=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),self._abort("server-error","Could not get an ID from the server."+pathError)},http.onreadystatechange=function(){return 4===http.readyState?200!==http.status?void http.onerror():void self._initialize(http.responseText):void 0},http.send(null)},Peer.prototype._initialize=function(id){this.id=id,this.socket.start(this.id,this.options.token)},Peer.prototype._handleMessage=function(message){var connection,type=message.type,payload=message.payload,peer=message.src;switch(type){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",payload.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":util.log("Received leave message from",peer),this._cleanupPeer(peer);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+peer);break;case"OFFER":var connectionId=payload.connectionId;if(connection=this.getConnection(peer,connectionId))util.warn("Offer received for existing Connection ID:",connectionId);else{if("media"===payload.type)connection=new MediaConnection(peer,this,{connectionId:connectionId,_payload:payload,metadata:payload.metadata}),this._addConnection(peer,connection),this.emit("call",connection);else{if("data"!==payload.type)return void util.warn("Received malformed connection type:",payload.type);connection=new DataConnection(peer,this,{connectionId:connectionId,_payload:payload,metadata:payload.metadata,label:payload.label,serialization:payload.serialization,reliable:payload.reliable}),this._addConnection(peer,connection),this.emit("connection",connection)}for(var messages=this._getMessages(connectionId),i=0,ii=messages.length;ii>i;i+=1)connection.handleMessage(messages[i])}break;default:if(!payload)return void util.warn("You received a malformed message from "+peer+" of type "+type);var id=payload.connectionId;connection=this.getConnection(peer,id),connection&&connection.pc?connection.handleMessage(message):id?this._storeMessage(id,message):util.warn("You received an unrecognized message:",message)}},Peer.prototype._storeMessage=function(connectionId,message){this._lostMessages[connectionId]||(this._lostMessages[connectionId]=[]),this._lostMessages[connectionId].push(message)},Peer.prototype._getMessages=function(connectionId){var messages=this._lostMessages[connectionId];return messages?(delete this._lostMessages[connectionId],messages):[]},Peer.prototype.connect=function(peer,options){if(this.disconnected)return util.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var connection=new DataConnection(peer,this,options);return this._addConnection(peer,connection),connection},Peer.prototype.call=function(peer,stream,options){if(this.disconnected)return util.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(!stream)return void util.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");options=options||{},options._stream=stream;var call=new MediaConnection(peer,this,options);return this._addConnection(peer,call),call},Peer.prototype._addConnection=function(peer,connection){this.connections[peer]||(this.connections[peer]=[]),this.connections[peer].push(connection)},Peer.prototype.getConnection=function(peer,id){var connections=this.connections[peer];if(!connections)return null;for(var i=0,ii=connections.length;ii>i;i++)if(connections[i].id===id)return connections[i];return null},Peer.prototype._delayedAbort=function(type,message){var self=this;util.setZeroTimeout(function(){self._abort(type,message)})},Peer.prototype._abort=function(type,message){util.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(type,message)},Peer.prototype.emitError=function(type,err){util.error("Error:",err),"string"==typeof err&&(err=new Error(err)),err.type=type,this.emit("error",err)},Peer.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},Peer.prototype._cleanup=function(){if(this.connections)for(var peers=Object.keys(this.connections),i=0,ii=peers.length;ii>i;i++)this._cleanupPeer(peers[i]);this.emit("close")},Peer.prototype._cleanupPeer=function(peer){for(var connections=this.connections[peer],j=0,jj=connections.length;jj>j;j+=1)connections[j].close()},Peer.prototype.disconnect=function(){var self=this;util.setZeroTimeout(function(){self.disconnected||(self.disconnected=!0,self.open=!1,self.socket&&self.socket.close(),self.emit("disconnected",self.id),self._lastServerId=self.id,self.id=null)})},Peer.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)util.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");util.error("In a hurry? We're still trying to make the initial connection!")}},Peer.prototype.listAllPeers=function(cb){cb=cb||function(){};var self=this,http=new XMLHttpRequest,protocol=this.options.secure?"https://":"http://",url=protocol+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers",queryString="?ts="+(new Date).getTime()+Math.random();url+=queryString,http.open("get",url,!0),http.onerror=function(e){self._abort("server-error","Could not get peers from the server."),cb([])},http.onreadystatechange=function(){if(4===http.readyState){if(401===http.status){var helpfulError="";throw helpfulError=self.options.host!==util.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",cb([]),new Error("It doesn't look like you have permission to list peers IDs. "+helpfulError)}cb(200!==http.status?[]:JSON.parse(http.responseText))}},http.send(null)},module.exports=Peer},{"./dataconnection":3,"./mediaconnection":4,"./socket":7,"./util":8,eventemitter3:9}],7:[function(require,module,exports){function Socket(secure,host,port,path,key){if(!(this instanceof Socket))return new Socket(secure,host,port,path,key);EventEmitter.call(this),this.disconnected=!1,this._queue=[];var httpProtocol=secure?"https://":"http://",wsProtocol=secure?"wss://":"ws://";this._httpUrl=httpProtocol+host+":"+port+path+key,this._wsUrl=wsProtocol+host+":"+port+path+"peerjs?key="+key}var util=require("./util"),EventEmitter=require("eventemitter3");util.inherits(Socket,EventEmitter),Socket.prototype.start=function(id,token){this.id=id,this._httpUrl+="/"+id+"/"+token,this._wsUrl+="&id="+id+"&token="+token,this._startXhrStream(),this._startWebSocket()},Socket.prototype._startWebSocket=function(id){var self=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(event){try{var data=JSON.parse(event.data)}catch(e){return void util.log("Invalid server message",event.data)}self.emit("message",data)},this._socket.onclose=function(event){util.log("Socket closed."),self.disconnected=!0,self.emit("disconnected")},this._socket.onopen=function(){self._timeout&&(clearTimeout(self._timeout),setTimeout(function(){self._http.abort(),self._http=null},5e3)),self._sendQueuedMessages(),util.log("Socket open")})},Socket.prototype._startXhrStream=function(n){try{var self=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=n||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onerror=function(){clearTimeout(self._timeout),self.emit("disconnected")},this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):this.readyState>2&&200===this.status&&this.responseText&&self._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(e){util.log("XMLHttpRequest not available; defaulting to WebSockets")}},Socket.prototype._handleStream=function(http){var messages=http.responseText.split("\n");if(http._buffer)for(;http._buffer.length>0;){var index=http._buffer.shift(),bufferedMessage=messages[index];try{bufferedMessage=JSON.parse(bufferedMessage)}catch(e){http._buffer.shift(index);break}this.emit("message",bufferedMessage)}var message=messages[http._index];if(message)if(http._index+=1,http._index===messages.length)http._buffer||(http._buffer=[]),http._buffer.push(http._index-1);else{try{message=JSON.parse(message)}catch(e){return void util.log("Invalid server message",message)}this.emit("message",message)}},Socket.prototype._setHTTPTimeout=function(){var self=this;this._timeout=setTimeout(function(){var old=self._http;self._wsOpen()?old.abort():(self._startXhrStream(old._streamIndex+1),self._http.old=old)},25e3)},Socket.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},Socket.prototype._sendQueuedMessages=function(){for(var i=0,ii=this._queue.length;ii>i;i+=1)this.send(this._queue[i])},Socket.prototype.send=function(data){if(!this.disconnected){if(!this.id)return void this._queue.push(data);if(!data.type)return void this.emit("error","Invalid message");var message=JSON.stringify(data);if(this._wsOpen())this._socket.send(message);else{var http=new XMLHttpRequest,url=this._httpUrl+"/"+data.type.toLowerCase();http.open("post",url,!0),http.setRequestHeader("Content-Type","application/json"),http.send(message)}}},Socket.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)},module.exports=Socket},{"./util":8,eventemitter3:9}],8:[function(require,module,exports){var defaultConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]},dataCount=1,BinaryPack=require("js-binarypack"),RTCPeerConnection=require("./adapter").RTCPeerConnection,util={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(level){var debugLevel=parseInt(level,10);isNaN(parseInt(level,10))?util.logLevel=level?3:0:util.logLevel=debugLevel,util.log=util.warn=util.error=util.noop,util.logLevel>0&&(util.error=util._printWith("ERROR")),util.logLevel>1&&(util.warn=util._printWith("WARNING")),util.logLevel>2&&(util.log=util._print)},setLogFunction:function(fn){fn.constructor!==Function?util.warn("The log function you passed in is not a function. Defaulting to regular logs."):util._print=fn},_printWith:function(prefix){return function(){var copy=Array.prototype.slice.call(arguments);copy.unshift(prefix),util._print.apply(util,copy)}},_print:function(){var err=!1,copy=Array.prototype.slice.call(arguments);copy.unshift("PeerJS: ");for(var i=0,l=copy.length;l>i;i++)copy[i]instanceof Error&&(copy[i]="("+copy[i].name+") "+copy[i].message,err=!0);err?console.error.apply(console,copy):console.log.apply(console,copy)},defaultConfig:defaultConfig,browser:function(){return window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof RTCPeerConnection)return{};var pc,dc,data=!0,audioVideo=!0,binaryBlob=!1,sctp=!1,onnegotiationneeded=!!window.webkitRTCPeerConnection;try{pc=new RTCPeerConnection(defaultConfig,{optional:[{RtpDataChannels:!0}]})}catch(e){data=!1,audioVideo=!1}if(data)try{dc=pc.createDataChannel("_PEERJSTEST")}catch(e){data=!1}if(data){try{dc.binaryType="blob",binaryBlob=!0}catch(e){}var reliablePC=new RTCPeerConnection(defaultConfig,{});try{var reliableDC=reliablePC.createDataChannel("_PEERJSRELIABLETEST",{});sctp=reliableDC.reliable}catch(e){}reliablePC.close()}if(audioVideo&&(audioVideo=!!pc.addStream),!onnegotiationneeded&&data){var negotiationPC=new RTCPeerConnection(defaultConfig,{optional:[{RtpDataChannels:!0}]});negotiationPC.onnegotiationneeded=function(){onnegotiationneeded=!0,util&&util.supports&&(util.supports.onnegotiationneeded=!0)},negotiationPC.createDataChannel("_PEERJSNEGOTIATIONTEST"),setTimeout(function(){negotiationPC.close()},1e3)}return pc&&pc.close(),{audioVideo:audioVideo,data:data,binaryBlob:binaryBlob,binary:sctp,reliable:sctp,sctp:sctp,onnegotiationneeded:onnegotiationneeded}}(),validateId:function(id){return!id||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(id)},validateKey:function(key){return!key||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(key)},debug:!1,inherits:function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})},extend:function(dest,source){for(var key in source)source.hasOwnProperty(key)&&(dest[key]=source[key]);return dest},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(util.debug){var err=!1,copy=Array.prototype.slice.call(arguments);copy.unshift("PeerJS: ");for(var i=0,l=copy.length;l>i;i++)copy[i]instanceof Error&&(copy[i]="("+copy[i].name+") "+copy[i].message,err=!0);err?console.error.apply(console,copy):console.log.apply(console,copy)}},setZeroTimeout:function(global){function setZeroTimeoutPostMessage(fn){timeouts.push(fn),global.postMessage(messageName,"*")}function handleMessage(event){event.source==global&&event.data==messageName&&(event.stopPropagation&&event.stopPropagation(),timeouts.length&&timeouts.shift()())}var timeouts=[],messageName="zero-timeout-message";return global.addEventListener?global.addEventListener("message",handleMessage,!0):global.attachEvent&&global.attachEvent("onmessage",handleMessage),setZeroTimeoutPostMessage}(window),chunk:function(bl){for(var chunks=[],size=bl.size,start=index=0,total=Math.ceil(size/util.chunkedMTU);size>start;){var end=Math.min(size,start+util.chunkedMTU),b=bl.slice(start,end),chunk={__peerData:dataCount,n:index,data:b,total:total};chunks.push(chunk),start=end,index+=1}return dataCount+=1,chunks},blobToArrayBuffer:function(blob,cb){var fr=new FileReader;fr.onload=function(evt){cb(evt.target.result)},fr.readAsArrayBuffer(blob)},blobToBinaryString:function(blob,cb){var fr=new FileReader;fr.onload=function(evt){cb(evt.target.result)},fr.readAsBinaryString(blob)},binaryStringToArrayBuffer:function(binary){for(var byteArray=new Uint8Array(binary.length),i=0;i<binary.length;i++)byteArray[i]=255&binary.charCodeAt(i);return byteArray.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};module.exports=util},{"./adapter":2,"js-binarypack":10}],9:[function(require,module,exports){"use strict";function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function EventEmitter(){}EventEmitter.prototype._events=void 0,EventEmitter.prototype.listeners=function(event){if(!this._events||!this._events[event])return[];if(this._events[event].fn)return[this._events[event].fn];
for(var i=0,l=this._events[event].length,ee=new Array(l);l>i;i++)ee[i]=this._events[event][i].fn;return ee},EventEmitter.prototype.emit=function(event,a1,a2,a3,a4,a5){if(!this._events||!this._events[event])return!1;var args,i,listeners=this._events[event],len=arguments.length;if("function"==typeof listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=new Array(len-1);len>i;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;length>i;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;default:if(!args)for(j=1,args=new Array(len-1);len>j;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function(event,fn,context){var listener=new EE(fn,context||this);return this._events||(this._events={}),this._events[event]?this._events[event].fn?this._events[event]=[this._events[event],listener]:this._events[event].push(listener):this._events[event]=listener,this},EventEmitter.prototype.once=function(event,fn,context){var listener=new EE(fn,context||this,!0);return this._events||(this._events={}),this._events[event]?this._events[event].fn?this._events[event]=[this._events[event],listener]:this._events[event].push(listener):this._events[event]=listener,this},EventEmitter.prototype.removeListener=function(event,fn,once){if(!this._events||!this._events[event])return this;var listeners=this._events[event],events=[];if(fn&&(listeners.fn&&(listeners.fn!==fn||once&&!listeners.once)&&events.push(listeners),!listeners.fn))for(var i=0,length=listeners.length;length>i;i++)(listeners[i].fn!==fn||once&&!listeners[i].once)&&events.push(listeners[i]);return events.length?this._events[event]=1===events.length?events[0]:events:delete this._events[event],this},EventEmitter.prototype.removeAllListeners=function(event){return this._events?(event?delete this._events[event]:this._events={},this):this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.setMaxListeners=function(){return this},EventEmitter.EventEmitter=EventEmitter,EventEmitter.EventEmitter2=EventEmitter,EventEmitter.EventEmitter3=EventEmitter,module.exports=EventEmitter},{}],10:[function(require,module,exports){function Unpacker(data){this.index=0,this.dataBuffer=data,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function Packer(){this.bufferBuilder=new BufferBuilder}function _utf8Replace(m){var code=m.charCodeAt(0);return 2047>=code?"00":65535>=code?"000":2097151>=code?"0000":67108863>=code?"00000":"000000"}function utf8Length(str){return str.length>600?new Blob([str]).size:str.replace(/[^\u0000-\u007F]/g,_utf8Replace).length}var BufferBuilder=require("./bufferbuilder").BufferBuilder,binaryFeatures=require("./bufferbuilder").binaryFeatures,BinaryPack={unpack:function(data){var unpacker=new Unpacker(data);return unpacker.unpack()},pack:function(data){var packer=new Packer;packer.pack(data);var buffer=packer.getBuffer();return buffer}};module.exports=BinaryPack,Unpacker.prototype.unpack=function(){var type=this.unpack_uint8();if(128>type){var positive_fixnum=type;return positive_fixnum}if(32>(224^type)){var negative_fixnum=(224^type)-32;return negative_fixnum}var size;if((size=160^type)<=15)return this.unpack_raw(size);if((size=176^type)<=15)return this.unpack_string(size);if((size=144^type)<=15)return this.unpack_array(size);if((size=128^type)<=15)return this.unpack_map(size);switch(type){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return size=this.unpack_uint16(),this.unpack_string(size);case 217:return size=this.unpack_uint32(),this.unpack_string(size);case 218:return size=this.unpack_uint16(),this.unpack_raw(size);case 219:return size=this.unpack_uint32(),this.unpack_raw(size);case 220:return size=this.unpack_uint16(),this.unpack_array(size);case 221:return size=this.unpack_uint32(),this.unpack_array(size);case 222:return size=this.unpack_uint16(),this.unpack_map(size);case 223:return size=this.unpack_uint32(),this.unpack_map(size)}},Unpacker.prototype.unpack_uint8=function(){var byte=255&this.dataView[this.index];return this.index++,byte},Unpacker.prototype.unpack_uint16=function(){var bytes=this.read(2),uint16=256*(255&bytes[0])+(255&bytes[1]);return this.index+=2,uint16},Unpacker.prototype.unpack_uint32=function(){var bytes=this.read(4),uint32=256*(256*(256*bytes[0]+bytes[1])+bytes[2])+bytes[3];return this.index+=4,uint32},Unpacker.prototype.unpack_uint64=function(){var bytes=this.read(8),uint64=256*(256*(256*(256*(256*(256*(256*bytes[0]+bytes[1])+bytes[2])+bytes[3])+bytes[4])+bytes[5])+bytes[6])+bytes[7];return this.index+=8,uint64},Unpacker.prototype.unpack_int8=function(){var uint8=this.unpack_uint8();return 128>uint8?uint8:uint8-256},Unpacker.prototype.unpack_int16=function(){var uint16=this.unpack_uint16();return 32768>uint16?uint16:uint16-65536},Unpacker.prototype.unpack_int32=function(){var uint32=this.unpack_uint32();return uint32<Math.pow(2,31)?uint32:uint32-Math.pow(2,32)},Unpacker.prototype.unpack_int64=function(){var uint64=this.unpack_uint64();return uint64<Math.pow(2,63)?uint64:uint64-Math.pow(2,64)},Unpacker.prototype.unpack_raw=function(size){if(this.length<this.index+size)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+size+" "+this.length);var buf=this.dataBuffer.slice(this.index,this.index+size);return this.index+=size,buf},Unpacker.prototype.unpack_string=function(size){for(var c,code,bytes=this.read(size),i=0,str="";size>i;)c=bytes[i],128>c?(str+=String.fromCharCode(c),i++):32>(192^c)?(code=(192^c)<<6|63&bytes[i+1],str+=String.fromCharCode(code),i+=2):(code=(15&c)<<12|(63&bytes[i+1])<<6|63&bytes[i+2],str+=String.fromCharCode(code),i+=3);return this.index+=size,str},Unpacker.prototype.unpack_array=function(size){for(var objects=new Array(size),i=0;size>i;i++)objects[i]=this.unpack();return objects},Unpacker.prototype.unpack_map=function(size){for(var map={},i=0;size>i;i++){var key=this.unpack(),value=this.unpack();map[key]=value}return map},Unpacker.prototype.unpack_float=function(){var uint32=this.unpack_uint32(),sign=uint32>>31,exp=(uint32>>23&255)-127,fraction=8388607&uint32|8388608;return(0==sign?1:-1)*fraction*Math.pow(2,exp-23)},Unpacker.prototype.unpack_double=function(){var h32=this.unpack_uint32(),l32=this.unpack_uint32(),sign=h32>>31,exp=(h32>>20&2047)-1023,hfrac=1048575&h32|1048576,frac=hfrac*Math.pow(2,exp-20)+l32*Math.pow(2,exp-52);return(0==sign?1:-1)*frac},Unpacker.prototype.read=function(length){var j=this.index;if(j+length<=this.length)return this.dataView.subarray(j,j+length);throw new Error("BinaryPackFailure: read index out of range")},Packer.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},Packer.prototype.pack=function(value){var type=typeof value;if("string"==type)this.pack_string(value);else if("number"==type)Math.floor(value)===value?this.pack_integer(value):this.pack_double(value);else if("boolean"==type)value===!0?this.bufferBuilder.append(195):value===!1&&this.bufferBuilder.append(194);else if("undefined"==type)this.bufferBuilder.append(192);else{if("object"!=type)throw new Error('Type "'+type+'" not yet supported');if(null===value)this.bufferBuilder.append(192);else{var constructor=value.constructor;if(constructor==Array)this.pack_array(value);else if(constructor==Blob||constructor==File)this.pack_bin(value);else if(constructor==ArrayBuffer)binaryFeatures.useArrayBufferView?this.pack_bin(new Uint8Array(value)):this.pack_bin(value);else if("BYTES_PER_ELEMENT"in value)binaryFeatures.useArrayBufferView?this.pack_bin(new Uint8Array(value.buffer)):this.pack_bin(value.buffer);else if(constructor==Object)this.pack_object(value);else if(constructor==Date)this.pack_string(value.toString());else{if("function"!=typeof value.toBinaryPack)throw new Error('Type "'+constructor.toString()+'" not yet supported');this.bufferBuilder.append(value.toBinaryPack())}}}this.bufferBuilder.flush()},Packer.prototype.pack_bin=function(blob){var length=blob.length||blob.byteLength||blob.size;if(15>=length)this.pack_uint8(160+length);else if(65535>=length)this.bufferBuilder.append(218),this.pack_uint16(length);else{if(!(4294967295>=length))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(length)}this.bufferBuilder.append(blob)},Packer.prototype.pack_string=function(str){var length=utf8Length(str);if(15>=length)this.pack_uint8(176+length);else if(65535>=length)this.bufferBuilder.append(216),this.pack_uint16(length);else{if(!(4294967295>=length))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(length)}this.bufferBuilder.append(str)},Packer.prototype.pack_array=function(ary){var length=ary.length;if(15>=length)this.pack_uint8(144+length);else if(65535>=length)this.bufferBuilder.append(220),this.pack_uint16(length);else{if(!(4294967295>=length))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(length)}for(var i=0;length>i;i++)this.pack(ary[i])},Packer.prototype.pack_integer=function(num){if(num>=-32&&127>=num)this.bufferBuilder.append(255&num);else if(num>=0&&255>=num)this.bufferBuilder.append(204),this.pack_uint8(num);else if(num>=-128&&127>=num)this.bufferBuilder.append(208),this.pack_int8(num);else if(num>=0&&65535>=num)this.bufferBuilder.append(205),this.pack_uint16(num);else if(num>=-32768&&32767>=num)this.bufferBuilder.append(209),this.pack_int16(num);else if(num>=0&&4294967295>=num)this.bufferBuilder.append(206),this.pack_uint32(num);else if(num>=-2147483648&&2147483647>=num)this.bufferBuilder.append(210),this.pack_int32(num);else if(num>=-0x8000000000000000&&0x8000000000000000>=num)this.bufferBuilder.append(211),this.pack_int64(num);else{if(!(num>=0&&0x10000000000000000>=num))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(num)}},Packer.prototype.pack_double=function(num){var sign=0;0>num&&(sign=1,num=-num);var exp=Math.floor(Math.log(num)/Math.LN2),frac0=num/Math.pow(2,exp)-1,frac1=Math.floor(frac0*Math.pow(2,52)),b32=Math.pow(2,32),h32=sign<<31|exp+1023<<20|frac1/b32&1048575,l32=frac1%b32;this.bufferBuilder.append(203),this.pack_int32(h32),this.pack_int32(l32)},Packer.prototype.pack_object=function(obj){var keys=Object.keys(obj),length=keys.length;if(15>=length)this.pack_uint8(128+length);else if(65535>=length)this.bufferBuilder.append(222),this.pack_uint16(length);else{if(!(4294967295>=length))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(length)}for(var prop in obj)obj.hasOwnProperty(prop)&&(this.pack(prop),this.pack(obj[prop]))},Packer.prototype.pack_uint8=function(num){this.bufferBuilder.append(num)},Packer.prototype.pack_uint16=function(num){this.bufferBuilder.append(num>>8),this.bufferBuilder.append(255&num)},Packer.prototype.pack_uint32=function(num){var n=4294967295&num;this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},Packer.prototype.pack_uint64=function(num){var high=num/Math.pow(2,32),low=num%Math.pow(2,32);this.bufferBuilder.append((4278190080&high)>>>24),this.bufferBuilder.append((16711680&high)>>>16),this.bufferBuilder.append((65280&high)>>>8),this.bufferBuilder.append(255&high),this.bufferBuilder.append((4278190080&low)>>>24),this.bufferBuilder.append((16711680&low)>>>16),this.bufferBuilder.append((65280&low)>>>8),this.bufferBuilder.append(255&low)},Packer.prototype.pack_int8=function(num){this.bufferBuilder.append(255&num)},Packer.prototype.pack_int16=function(num){this.bufferBuilder.append((65280&num)>>8),this.bufferBuilder.append(255&num)},Packer.prototype.pack_int32=function(num){this.bufferBuilder.append(num>>>24&255),this.bufferBuilder.append((16711680&num)>>>16),this.bufferBuilder.append((65280&num)>>>8),this.bufferBuilder.append(255&num)},Packer.prototype.pack_int64=function(num){var high=Math.floor(num/Math.pow(2,32)),low=num%Math.pow(2,32);this.bufferBuilder.append((4278190080&high)>>>24),this.bufferBuilder.append((16711680&high)>>>16),this.bufferBuilder.append((65280&high)>>>8),this.bufferBuilder.append(255&high),this.bufferBuilder.append((4278190080&low)>>>24),this.bufferBuilder.append((16711680&low)>>>16),this.bufferBuilder.append((65280&low)>>>8),this.bufferBuilder.append(255&low)}},{"./bufferbuilder":11}],11:[function(require,module,exports){function BufferBuilder(){this._pieces=[],this._parts=[]}var binaryFeatures={};binaryFeatures.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),binaryFeatures.useArrayBufferView=!binaryFeatures.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),module.exports.binaryFeatures=binaryFeatures;var BlobBuilder=module.exports.BlobBuilder;"undefined"!=typeof window&&(BlobBuilder=module.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder),BufferBuilder.prototype.append=function(data){"number"==typeof data?this._pieces.push(data):(this.flush(),this._parts.push(data))},BufferBuilder.prototype.flush=function(){if(this._pieces.length>0){var buf=new Uint8Array(this._pieces);binaryFeatures.useArrayBufferView||(buf=buf.buffer),this._parts.push(buf),this._pieces=[]}},BufferBuilder.prototype.getBuffer=function(){if(this.flush(),binaryFeatures.useBlobBuilder){for(var builder=new BlobBuilder,i=0,ii=this._parts.length;ii>i;i++)builder.append(this._parts[i]);return builder.getBlob()}return new Blob(this._parts)},module.exports.BufferBuilder=BufferBuilder},{}],12:[function(require,module,exports){function Reliable(dc,debug){return this instanceof Reliable?(this._dc=dc,util.debug=debug,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new Reliable(dc)}var util=require("./util");Reliable.prototype.send=function(msg){var bl=util.pack(msg);return bl.size<this._mtu?void this._handleSend(["no",bl]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(bl)},util.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},Reliable.prototype._setupInterval=function(){var self=this;this._timeout=setInterval(function(){var msg=self._queue.shift();if(msg._multiple)for(var i=0,ii=msg.length;ii>i;i+=1)self._intervalSend(msg[i]);else self._intervalSend(msg)},this._interval)},Reliable.prototype._intervalSend=function(msg){var self=this;msg=util.pack(msg),util.blobToBinaryString(msg,function(str){self._dc.send(str)}),0===self._queue.length&&(clearTimeout(self._timeout),self._timeout=null)},Reliable.prototype._processAcks=function(){for(var id in this._outgoing)this._outgoing.hasOwnProperty(id)&&this._sendWindowedChunks(id)},Reliable.prototype._handleSend=function(msg){for(var push=!0,i=0,ii=this._queue.length;ii>i;i+=1){var item=this._queue[i];item===msg?push=!1:item._multiple&&-1!==item.indexOf(msg)&&(push=!1)}push&&(this._queue.push(msg),this._timeout||this._setupInterval())},Reliable.prototype._setupDC=function(){var self=this;this._dc.onmessage=function(e){var msg=e.data,datatype=msg.constructor;if(datatype===String){var ab=util.binaryStringToArrayBuffer(msg);msg=util.unpack(ab),self._handleMessage(msg)}}},Reliable.prototype._handleMessage=function(msg){var data,id=msg[1],idata=this._incoming[id],odata=this._outgoing[id];switch(msg[0]){case"no":var message=id;message&&this.onmessage(util.unpack(message));break;case"end":if(data=idata,this._received[id]=msg[2],!data)break;this._ack(id);break;case"ack":if(data=odata){var ack=msg[2];data.ack=Math.max(ack,data.ack),data.ack>=data.chunks.length?(util.log("Time: ",new Date-data.timer),delete this._outgoing[id]):this._processAcks()}break;case"chunk":if(data=idata,!data){var end=this._received[id];if(end===!0)break;data={ack:["ack",id,0],chunks:[]},this._incoming[id]=data}var n=msg[2],chunk=msg[3];data.chunks[n]=new Uint8Array(chunk),n===data.ack[2]&&this._calculateNextAck(id),this._ack(id);break;default:this._handleSend(msg)}},Reliable.prototype._chunk=function(bl){for(var chunks=[],size=bl.size,start=0;size>start;){var end=Math.min(size,start+this._mtu),b=bl.slice(start,end),chunk={payload:b};chunks.push(chunk),start=end}return util.log("Created",chunks.length,"chunks."),chunks},Reliable.prototype._ack=function(id){var ack=this._incoming[id].ack;this._received[id]===ack[2]&&(this._complete(id),this._received[id]=!0),this._handleSend(ack)},Reliable.prototype._calculateNextAck=function(id){for(var data=this._incoming[id],chunks=data.chunks,i=0,ii=chunks.length;ii>i;i+=1)if(void 0===chunks[i])return void(data.ack[2]=i);data.ack[2]=chunks.length},Reliable.prototype._sendWindowedChunks=function(id){util.log("sendWindowedChunks for: ",id);for(var data=this._outgoing[id],ch=data.chunks,chunks=[],limit=Math.min(data.ack+this._window,ch.length),i=data.ack;limit>i;i+=1)ch[i].sent&&i!==data.ack||(ch[i].sent=!0,chunks.push(["chunk",id,i,ch[i].payload]));data.ack+this._window>=ch.length&&chunks.push(["end",id,ch.length]),chunks._multiple=!0,this._handleSend(chunks)},Reliable.prototype._complete=function(id){util.log("Completed called for",id);var self=this,chunks=this._incoming[id].chunks,bl=new Blob(chunks);util.blobToArrayBuffer(bl,function(ab){self.onmessage(util.unpack(ab))}),delete this._incoming[id]},Reliable.higherBandwidthSDP=function(sdp){var version=navigator.appVersion.match(/Chrome\/(.*?) /);if(version&&(version=parseInt(version[1].split(".").shift()),31>version)){var parts=sdp.split("b=AS:30"),replace="b=AS:102400";if(parts.length>1)return parts[0]+replace+parts[1]}return sdp},Reliable.prototype.onmessage=function(msg){},module.exports.Reliable=Reliable},{"./util":13}],13:[function(require,module,exports){var BinaryPack=require("js-binarypack"),util={debug:!1,inherits:function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})},extend:function(dest,source){for(var key in source)source.hasOwnProperty(key)&&(dest[key]=source[key]);return dest},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(util.debug){for(var copy=[],i=0;i<arguments.length;i++)copy[i]=arguments[i];copy.unshift("Reliable: "),console.log.apply(console,copy)}},setZeroTimeout:function(global){function setZeroTimeoutPostMessage(fn){timeouts.push(fn),global.postMessage(messageName,"*")}function handleMessage(event){event.source==global&&event.data==messageName&&(event.stopPropagation&&event.stopPropagation(),timeouts.length&&timeouts.shift()())}var timeouts=[],messageName="zero-timeout-message";return global.addEventListener?global.addEventListener("message",handleMessage,!0):global.attachEvent&&global.attachEvent("onmessage",handleMessage),setZeroTimeoutPostMessage}(this),blobToArrayBuffer:function(blob,cb){var fr=new FileReader;fr.onload=function(evt){cb(evt.target.result)},fr.readAsArrayBuffer(blob)},blobToBinaryString:function(blob,cb){var fr=new FileReader;fr.onload=function(evt){cb(evt.target.result)},fr.readAsBinaryString(blob)},binaryStringToArrayBuffer:function(binary){for(var byteArray=new Uint8Array(binary.length),i=0;i<binary.length;i++)byteArray[i]=255&binary.charCodeAt(i);return byteArray.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};module.exports=util},{"js-binarypack":10}]},{},[1]);
